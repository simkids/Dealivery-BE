import java.util.concurrent.atomic.AtomicInteger

import static net.grinder.script.Grinder.grinder;
import static org.junit.Assert.*;
import static org.hamcrest.Matchers.*;
import net.grinder.script.GTest
import net.grinder.scriptengine.groovy.junit.GrinderRunner;
import net.grinder.scriptengine.groovy.junit.annotation.BeforeProcess;
import net.grinder.scriptengine.groovy.junit.annotation.BeforeThread;
// import static net.grinder.util.GrinderUtils.* // You can use this if you're using nGrinder after 3.2.3
import org.junit.Before
import org.junit.Test;
import org.junit.runner.RunWith;

import org.ngrinder.http.HTTPRequest;
import org.ngrinder.http.HTTPRequestControl;
import org.ngrinder.http.HTTPResponse;
import HTTPClient.Cookie
import groovy.json.JsonSlurper;

/**
 * A simple example using the HTTP plugin that shows the retrieval of a single page via HTTP.
 *
 * This script is automatically generated by ngrinder.
 *
 * @author admin
 */
@RunWith(GrinderRunner.class)
class TestRunner {

    public static GTest test;
    public static HTTPRequest request;
    public static Map<String, String> headers = new HashMap<>();
    public static Map<String, Object> params = new HashMap<>();
    public static List<Cookie> cookies = new ArrayList<>();

    public static final String logicServerAddr = System.getenv('LOGIC_SERVER_ADDR');
    public static final String queueServerAddr = System.getenv('QUEUE_SERVER_ADDR');
    public static final String password = System.getenv('PASSWORD');

    public static final AtomicInteger number = new AtomicInteger(1); // 스레드 안전한 전역 변수
    private static final ThreadLocal<String> threadLoginBody = new ThreadLocal<>(); // 스레드별 loginBody 저장
    private static final ThreadLocal<List<Cookie>> threadCookies = ThreadLocal.withInitial(ArrayList::new) as ThreadLocal<List<Cookie>>;

    @BeforeProcess
    public static void beforeProcess() {
        HTTPRequestControl.setConnectionTimeout(300000);
        test = new GTest(1, "큐 입장 및 주문");
        request = new HTTPRequest();
        headers.put("Content-Type", "application/json");
        grinder.logger.info("Before process: HTTPRequest and headers initialized.");
    }

    @BeforeThread
    public void beforeThread() {
        test.record(this, "enterQueue");
        grinder.statistics.delayReports = true;

        // 1. AtomicInteger로 전역 number 값 증가 및 이메일 생성
        String email = "test" + number.getAndIncrement() + "@gmail.com;user";
        String loginBody = """
        {
            "email": "${email}",
            "password": "${password}"
        }
        """;

        // 2. 스레드별 loginBody 설정
        threadLoginBody.set(loginBody);

        grinder.logger.info("Thread {} assigned email: {} with loginBody: {}", grinder.threadNumber, email, loginBody);

        // 3. loginBody로 로그인 요청
        HTTPResponse response = request.POST(
                "${logicServerAddr}/login",
                loginBody.getBytes()
        );

        if (response.statusCode != 200) {
            grinder.logger.warn("[*** Status NOT 200 ***] Response Code: {}, Response Body: {}", response.statusCode, response.getBodyText());
        } else {
            // 4. 응답이 정상적으로 오면 쿠키 세팅 로직 수행
            processSuccessfulLoginResponse(response);
        }
    }

    @Before
    public void before() {
        request.setHeaders(headers);
        grinder.logger.info("Before: Headers and cookies initialized.");
    }

    @Test
    public void enterQueue() {

        Long boardIdx = 7319L // 게시판 ID
        Long orderedProductIdx = 7320L // 주문 상품 ID
        Long userIdx = 1L // 사용자 ID //TODO: JWT TOKEN 디코딩해서 동적으로 가져와야함.
        boolean isAccepted = false;

        // Step 1: 대기열 참여
        HTTPRequest request = new HTTPRequest() // HTTPRequest 객체 생성
        HTTPResponse enterResponse = request.GET("${queueServerAddr}/queue/waiting-room", [
                "boardIdx": boardIdx.toString(),
                "userIdx": userIdx.toString()
        ])

        assertThat(enterResponse.statusCode, is(200)) // 응답 코드 확인

        def enterBody = new JsonSlurper().parseText(enterResponse.getBodyText()) // 응답 본문 파싱
        grinder.logger.info("대기열 참여 응답: {}", enterResponse.getBodyText())

        // 응답 데이터의 'code' 값 확인 (code === 1000인 경우 입장 허가)
        if (enterBody.code == 1000) {
            grinder.logger.info("대기열 참여 완료. 즉시 입장 허가.")
            isAccepted = true;
        }

        // Step 2: 대기 순위 확인 반복
        if (!isAccepted) {
            grinder.logger.info("대기열 참여. 순위 확인 중...") // 순위 확인으로 진행

            while (true) {
                HTTPResponse rankResponse = request.GET("${queueServerAddr}/queue/rank", [
                        "boardIdx": boardIdx.toString(),
                        "userIdx": userIdx.toString()
                ])
                assertThat(rankResponse.statusCode, is(200))

                def rankBody = new JsonSlurper().parseText(rankResponse.getBodyText())
                Long rank = rankBody.result.rank
                grinder.logger.info("현재 순위: {}", rank)

                if (rank <= 1) {
                    grinder.logger.info("대기열 종료. 순위: {}", rank)
                    break
                }

                grinder.sleep(3000); // 대기 시간
            }
        }

        // Step 3: 대기열 종료 후 주문 요청
        List<Cookie> cookies = threadCookies.get(); // 스레드별 쿠키 가져오기
        String cookieHeader = cookies.collect { it.getName() + "=" + it.getValue() }.join("; "); // 쿠키를 헤더로 변환
        headers.put("Cookie", cookieHeader); // 쿠키를 헤더에 추가


        // 쿠키 값 로그 출력
        grinder.logger.info("Cookies being set: {}", cookieHeader);
        request.setHeaders(headers); // 헤더 설정


        def registerParams = [
                "boardIdx": "${boardIdx}",
                "orderedProducts": [
                        ["idx": "${orderedProductIdx}", "quantity": 1]
                ]
        ]
        def registerBody = new groovy.json.JsonBuilder(registerParams).toString()
        HTTPResponse registerResponse = request.POST("${logicServerAddr}/orders/register", registerBody.getBytes(), headers)

        // Response Handling
        assertThat(registerResponse.statusCode, is(200)) // 상태 코드 확인
        def responseBody = new JsonSlurper().parseText(registerResponse.getBodyText())
        grinder.logger.info("주문 요청 응답: {}", registerResponse.getBodyText())

        // Check response code and handle result
        if (responseBody.code == 1000) {
            grinder.logger.info("주문 성공: OrderIdx={}", responseBody.result.orderIdx)
        } else {
            grinder.logger.error("주문 실패: {}", responseBody.message)
        }
    }


    /** [로그인 성공 -> 쿠키 처리 로직] 쿠키 threadCookies에 저장 **/
    private void processSuccessfulLoginResponse(HTTPResponse response) {
        grinder.logger.info("Response Body: {}", response.getBodyText());

        try {
            List<String> cookieHeaders = response.getHeaders("Set-Cookie") as List<String>;

            if (cookieHeaders != null) {
                // 쿠키 있을 경우 쿠키 처리
                processCookies(cookieHeaders);
            } else {
                grinder.logger.warn("No Set-Cookie header found in the response.");
            }
        } catch (Exception e) {
            grinder.logger.error("Error while parsing cookies from response headers.", e);
        }
    }

    private void processCookies(List<String> cookieHeaders) {
        // 현재 스레드의 쿠키 저장 List
        List<Cookie> threadCookies = threadCookies.get();

        for (String cookieHeader : cookieHeaders) {
            String cookieString = extractCookieValue(cookieHeader);

            if (cookieString.startsWith("AToken=")) {
                processATokenCookie(cookieString, threadCookies);
            } else if (cookieString.startsWith("type=")) {
                processTypeCookie(cookieString, threadCookies);
            }
        }
    }

    private String extractCookieValue(String cookieHeader) {
        return cookieHeader.replaceFirst("Set-Cookie: ", "");
    }

    private void processATokenCookie(String cookieString, List<Cookie> threadCookies) {
        String token = cookieString.split(" ")[0].replaceFirst("AToken=", "").replaceFirst(";", "");
        Date oneDayLater = new Date(System.currentTimeMillis() + 24 * 60 * 60 * 1000L);
        Cookie atokenCookie = new Cookie("AToken", token, logicServerAddr, "/", oneDayLater, true);

        threadCookies.add(atokenCookie);
        grinder.logger.info("AToken Cookie: {}", atokenCookie);
    }

    private void processTypeCookie(String cookieString, List<Cookie> threadCookies) {
        Cookie typeCookie = new Cookie("type", "user", logicServerAddr, "/", null, true);
        threadCookies.add(typeCookie);
        grinder.logger.info("type Cookie: {}", typeCookie);
    }
}
